{% extends 'inventario/base.html' %}
{% load static %}

{% block content %}
<style>
    .sortable-grid .col-md-4.is-reordering { border: 2px dashed #0d6efd; background-color: var(--bs-secondary-bg); border-radius: 8px; padding: 10px; cursor: grab; }
    .col-hidden { display: none !important; }
    .sticky-top { z-index: 1020 !important; }
    .dropdown-menu { z-index: 1050 !important; }
    .tabla-editable tbody tr { cursor: pointer; transition: background-color 0.2s; }
    .tabla-editable tbody tr:hover { background-color: rgba(var(--bs-warning-rgb), 0.1) !important; }
</style>

<div class="d-flex justify-content-between align-items-center mb-4 mt-2">
    <div class="d-flex flex-column">
        <h2 class="mb-0 fw-bold text-body d-flex align-items-center">
            <img src="{% static 'inventario/images/caja.svg' %}" class="icono-tema me-3" width="32"> 
            Inventario: {{ selected_coll }}
        </h2>
        {% if ultimo_control %}
            <small class="text-secondary ms-5 mt-1" style="font-size: 0.85rem;">
                <img src="{% static 'inventario/images/reloj.svg' %}" width="12" class="opacity-50 me-1">
                √öltimo control: <strong>{{ ultimo_control.fecha|date:"d/m/Y" }}</strong> por <strong>{{ ultimo_control.usuario }}</strong>
            </small>
        {% endif %}
    </div>

    {% if vista_actual == 'ver' and selected_db and selected_coll %}
        <a href="{% url 'exportar_excel' selected_db selected_coll %}" class="btn btn-success shadow-sm fw-bold">Exportar a Excel</a>
    {% endif %}
</div>

{% if vista_actual == 'ver' %}
<div class="card bg-body-tertiary border-0 shadow-sm p-3 mb-4 text-start">
    <div class="mb-3 d-flex align-items-center">
        <img src="{% static 'inventario/images/buscar.svg' %}" class="icono-tema me-2" width="22">
        <input type="text" id="buscadorGlobal" class="form-control border-primary shadow-sm" placeholder="Buscar..." onkeyup="filtrarTabla('tablaInventarioVer', 'buscadorGlobal')">
    </div>
    <div class="table-responsive" style="min-height: 400px;">
        <table class="table table-hover border mb-0 text-start" id="tablaInventarioVer">
            <thead class="bg-body-secondary border-bottom border-2 sticky-top">
                <tr>
                    {% for c in campos_tabla %}
                        <th class="align-middle border-end border-secondary-subtle" style="min-width: 140px;">
                            <div class="d-flex justify-content-between align-items-center w-100">
                                <span class="fw-bold text-truncate pe-1" title="{{ c.alias }}">{{ c.alias }}</span>
                                <div class="dropdown"><button class="btn btn-sm p-0 border-0" type="button" data-bs-toggle="dropdown"><img src="{% static 'inventario/images/filtro.svg' %}" width="12" class="icono-tema"></button><ul class="dropdown-menu shadow-sm p-2 border-secondary" id="filtro-col-{{ forloop.counter0 }}"></ul></div>
                            </div>
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for p in productos %}
                <tr class="fila-dato">
                    {% for celda in p.celdas %}
                        <td>{{ celda.valor }}</td>
                    {% endfor %}
                </tr>
                {% empty %}
                <tr><td colspan="100%" class="text-center text-muted py-4">No hay registros.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if vista_actual == 'control' and puede_editar %}
<div class="card p-4 border-0 shadow-sm bg-body-tertiary text-start">
    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
        <h5 class="fw-bold text-body mb-0 d-flex align-items-center">
            <img src="{% static 'inventario/images/lista.svg' %}" class="icono-tema me-2" width="20"> Control de Inventario
        </h5>
        <div class="d-flex align-items-center gap-2">
            <span class="badge bg-primary-subtle text-primary border border-primary fw-bold" id="contadorControl">0 Seleccionados</span>
            <button type="button" class="btn btn-sm btn-success fw-bold shadow-sm" onclick="enviarControlInventario()" id="btnGuardarControl" disabled>
                <img src="{% static 'inventario/images/guardar.svg' %}" width="16" class="me-1" style="filter: brightness(0) invert(1);"> Confirmar Cambios
            </button>
        </div>
    </div>

    <div class="mb-3 d-flex align-items-center">
        <img src="{% static 'inventario/images/lupa.svg' %}" class="icono-tema me-2" width="22">
        <input type="text" id="buscadorControl" class="form-control border-primary shadow-sm" placeholder="Buscar..." onkeyup="filtrarTabla('tablaControl', 'buscadorControl')">
    </div>

    <form method="POST" id="formControlInventario">
        {% csrf_token %}
        <input type="hidden" name="action" value="control_inventario">
        <input type="hidden" name="control_data" id="inputControlData">

        <div class="table-responsive border rounded bg-body" style="max-height: 600px;">
            <table class="table table-hover mb-0 align-middle table-sm" id="tablaControl">
                <thead class="bg-body-secondary sticky-top border-bottom border-2 z-3">
                    <tr>
                        <th style="width: 40px;" class="text-center bg-body-secondary">
                            <input type="checkbox" class="form-check-input border-secondary-subtle" id="checkAllControl" onchange="toggleAllControl(this)">
                        </th>
                        <th style="width: 100px;">Estado</th>
                        {% for c in campos_tabla %}
                            <th style="min-width: 120px;">{{ c.alias }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for p in productos %}
                    <tr class="fila-dato fila-control" data-id="{{ p.id }}" data-nombre="{{ p.nombre_producto }}">
                        <td class="text-center">
                            <input type="checkbox" class="form-check-input check-control border-secondary-subtle" onchange="validarBotonControl()">
                        </td>
                        <td class="td-estado text-center">
                            <span class="badge bg-success-subtle text-success border border-success-subtle w-100">Sin Cambios</span>
                        </td>
                        
                        {% for celda in p.celdas %}
                            <td class="p-1">
                                {% if celda.config.tipo == 'calc_stock' or celda.config.tipo == 'calc_venc' %}
                                    <input type="text" class="form-control form-control-sm border-0 bg-secondary-subtle text-muted" value="{{ celda.valor }}" disabled>
                                
                                {% elif celda.config.tipo == 'date' %}
                                    <input type="text" 
                                           class="form-control form-control-sm border-0 bg-transparent input-control-dinamico input-fecha fw-bold" 
                                           value="{{ celda.valor }}" 
                                           data-original="{{ celda.valor }}"
                                           data-campo="{{ celda.config.nombre }}"
                                           onchange="detectarCambioFila(this)"> {% else %}
                                    <input type="text" 
                                           class="form-control form-control-sm border-0 bg-transparent input-control-dinamico" 
                                           value="{{ celda.valor }}" 
                                           data-original="{{ celda.valor }}"
                                           data-campo="{{ celda.config.nombre }}"
                                           oninput="detectarCambioFila(this)">
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% empty %}
                    <tr><td colspan="100%" class="text-center py-4 text-muted">No hay registros para controlar.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>

    </form> 

        <div class="modal fade" id="modalConfirmarControl" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-success-subtle">
                        <h5 class="modal-title fw-bold text-success-emphasis">
                            <img src="{% static 'inventario/images/check.svg' %}" width="20" class="me-2">Confirmar Ajustes
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning border-warning d-flex align-items-center mb-3">
                            <img src="{% static 'inventario/images/alerta.svg' %}" width="24" class="me-3">
                            <div>
                                <strong>¬°Atenci√≥n!</strong> Est√°s a punto de modificar el stock real en la base de datos.
                            </div>
                        </div>

                        <h6 class="fw-bold mb-3">Resumen de Cambios:</h6>
                        <div class="table-responsive border rounded mb-4">
                            <table class="table table-sm table-striped mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Producto</th>
                                        <th>Campo</th>
                                        <th class="text-danger">Valor Anterior</th>
                                        <th class="text-success">Valor Nuevo</th>
                                    </tr>
                                </thead>
                                <tbody id="bodyResumenCambios">
                                    </tbody>
                            </table>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Contrase√±a de confirmaci√≥n:</label>
                            <input type="password" id="passwordConfirmControl" class="form-control border-success" placeholder="Tu contrase√±a...">
                        </div>
                    </div>
                    <div class="modal-footer bg-body-tertiary">
                        <button type="button" class="btn btn-secondary fw-bold" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success fw-bold px-4" onclick="submitControlFinal()">
                            <img src="{% static 'inventario/images/guardar.svg' %}" width="16" class="me-2" style="filter: brightness(0) invert(1);">
                            Confirmar y Guardar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div> {% endif %}
    
</div>


{% if vista_actual == 'crear' and puede_editar %}
<div class="card p-4 border-0 shadow-sm bg-body-tertiary text-start">
    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
        <h5 class="fw-bold text-body mb-0">A√±adir Nuevo Registro</h5>
        <div>
            <button type="button" class="btn btn-sm btn-outline-secondary fw-bold" id="btnToggleOrder" onclick="toggleReorderMode()">Reordenar</button>
            <button type="button" class="btn btn-sm btn-success d-none fw-bold" id="btnSaveOrder" onclick="guardarOrdenPreferido()">Guardar</button>
        </div>
    </div>
    <form method="POST">
        {% csrf_token %}<input type="hidden" name="action" value="crear"><input type="hidden" name="vista_actual" value="crear">
        <div class="row g-3 sortable-grid">
            {% for c in campos_formulario %}
                {% if c.tipo != 'calc_stock' and c.tipo != 'calc_venc' %}
                <div class="col-md-4">
                    <label class="small fw-bold">{{ c.alias }}</label>
                    <input type="{% if c.tipo == 'date' %}text{% else %}{{ c.tipo }}{% endif %}" name="campo_{{ c.nombre }}" class="form-control {% if c.tipo == 'date' %}input-fecha{% endif %}" {% if c.nombre == 'Producto' %}required{% endif %}>
                </div>
                {% endif %}
            {% endfor %}
        </div>
        <button type="submit" class="btn btn-primary mt-4 fw-bold w-100">Guardar Registro</button>
    </form>
</div>
{% endif %}

{% if vista_actual == 'editar' and puede_editar %}
<div class="card p-4 border-0 shadow-sm bg-body-tertiary text-start">
    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
        <h5 class="fw-bold text-body mb-0">Modificar Registros</h5>
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary fw-bold dropdown-toggle" data-bs-toggle="dropdown">üëÅÔ∏è Ver Columnas</button>
            <ul class="dropdown-menu shadow-sm p-3" style="min-width: 250px;">
                {% for c in campos_tabla %}
                    <li><div class="form-check"><input class="form-check-input" type="checkbox" id="col_vis_{{ forloop.counter0 }}" checked onchange="toggleColumna('{{ forloop.counter0 }}')"><label class="form-check-label small" for="col_vis_{{ forloop.counter0 }}">{{ c.alias }}</label></div></li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="mb-3 d-flex align-items-center">
        <img src="{% static 'inventario/images/buscar.svg' %}" class="icono-tema me-2" width="22">
        <input type="text" id="buscadorEditar" class="form-control border-warning shadow-sm" placeholder="Buscar..." onkeyup="filtrarTabla('tablaInventarioEditar', 'buscadorEditar')">
    </div>
    <div class="table-responsive border rounded bg-body" style="max-height: 500px;">
        <table class="table table-hover mb-0 align-middle tabla-editable" id="tablaInventarioEditar">
            <thead class="bg-warning-subtle text-dark border-bottom border-warning sticky-top">
                <tr>
                    {% for c in campos_tabla %}
                        <th class="col-idx-{{ forloop.counter0 }} align-middle border-end border-secondary-subtle" style="min-width: 140px;">
                            <div class="d-flex justify-content-between align-items-center w-100">
                                <span class="fw-bold text-truncate pe-1">{{ c.alias }}</span>
                                <div class="dropdown"><button class="btn btn-sm p-0 border-0" data-bs-toggle="dropdown"><img src="{% static 'inventario/images/filtro.svg' %}" width="12" style="filter: brightness(0);"></button><ul class="dropdown-menu shadow-sm p-2" id="filtro-edit-col-{{ forloop.counter0 }}"></ul></div>
                            </div>
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for p in productos %}
                <tr class="fila-dato" onclick="abrirModalEditar('{{ p.id }}', this)" data-json='{{ p.raw_json|safe }}'>
                    {% for celda in p.celdas %}
                        <td class="col-idx-{{ forloop.counter0 }} small fw-semibold">{{ celda.valor }}</td>
                    {% endfor %}
                </tr>
                {% empty %}
                <tr><td colspan="100%" class="text-center py-4 text-muted">No hay registros.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalEditarRegistro" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning-subtle">
                <h5 class="modal-title fw-bold text-dark">Editando: <span id="tituloModalProducto">...</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-body-tertiary">
                <form method="POST" id="formEditarDinamico">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="editar"><input type="hidden" name="vista_actual" value="editar"><input type="hidden" name="doc_id" id="input_doc_id">
                    <div class="row g-3 sortable-grid">
                        {% for c in campos_formulario %}
                            {% if c.tipo != 'calc_stock' and c.tipo != 'calc_venc' %}
                            <div class="col-md-4">
                                <label class="small fw-bold text-secondary">{{ c.alias }}</label>
                                <input type="{% if c.tipo == 'date' %}text{% else %}{{ c.tipo }}{% endif %}" name="campo_{{ c.nombre }}" data-campo-nombre="{{ c.nombre }}" class="form-control fw-bold border-secondary-subtle {% if c.tipo == 'date' %}input-fecha{% endif %}" {% if c.nombre == 'Producto' %}required{% endif %}>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="mt-4 text-end border-top pt-3">
                        <button type="button" class="btn btn-secondary fw-bold me-2" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning fw-bold shadow-sm px-4">üíæ Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if vista_actual == 'borrar' and request.user.rol in 'admin,superuser' %}
<div class="card p-4 border-0 shadow-sm bg-body-tertiary text-start">
    <h5 class="fw-bold text-body mb-3 border-bottom pb-2">Eliminar Registros</h5>
    <form method="POST">
        {% csrf_token %}<input type="hidden" name="action" value="borrar"><input type="hidden" name="vista_actual" value="borrar">
        <table class="table border">
            <thead class="bg-body-secondary"><tr><th>Borrar?</th><th>Producto</th></tr></thead>
            <tbody>
                {% for p in productos %}<tr><td><input class="form-check-input" type="checkbox" name="delete_ids" value="{{ p.id }}"></td><td class="fw-bold">{{ p.nombre_producto }}</td></tr>{% endfor %}
            </tbody>
        </table>
        <button type="button" class="btn btn-danger mt-3 fw-bold w-100" data-bs-toggle="modal" data-bs-target="#borrarModal">Eliminar Seleccionados</button>
        
        <div class="modal fade" id="borrarModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title fw-bold">Seguridad</h5></div><div class="modal-body"><p>Ingresa tu clave:</p><input type="password" name="password_confirm" class="form-control border-danger" required></div><div class="modal-footer"><button type="button" class="btn btn-secondary fw-bold" data-bs-dismiss="modal">Cancelar</button><button type="submit" class="btn btn-danger fw-bold">Confirmar</button></div></div></div></div>
    </form>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<div id="inventario-data" style="display: none;" 
     data-url-guardar="{% url 'guardar_orden_form' %}"
     data-selected-db="{{ selected_db }}">
</div>
<script>
    const dataContainer = document.getElementById('inventario-data');
    const URL_GUARDAR_ORDEN = dataContainer.dataset.urlGuardar;
    const SELECTED_DB = dataContainer.dataset.selectedDb;
</script>
<script src="{% static 'inventario/js/inventario.js' %}"></script>
{% endblock %}